![img.png](src/main/resources/img/logo.png)
# Centralized Data Ingestion Service with Aiven Kafka 
## - A quick start for Java and Springboot
Aiven for Apache Kafka is a fully managed distributed data streaming platform, deployable in the cloud of your choice. Apache Kafka is an open source data streaming platform, ideal for event-driven applications, near-real-time data transfer and pipelines, stream analytics, and many more applications where a lot of data needs to move between applications in a speedy manner.

Data platform developers or application developers need to ingest the data generated by applications to Kafka cluster for stream processing. Based on Aiven Kafka, this tutorial presents how to use Springboot framework to build a Kafka producing service. The tutorial contains 4 steps, including create an Aiven Kafka Service, setting up Java SSL access, Springboot integration, and local testing. 

## Create Aiven Kafka Service

Aiven services are managed in the Aiven web console . When you first log in to the console with your email address and password, you will see the Services view, which shows you all the services in the currently selected project.

Create a new Aiven for Apache Kafka® service:

1. Select Kafka as the service type. You can also select the version that you want to use.

2. Select the cloud provider and region that you want to run your service on.

3. Select a service plan. This defines how many servers and what kind of memory, CPU, and disk resources are allocated to your service.

4. Enter a name for your service. A random name is provided by default, but you can enter a more recognizable name to distinguish it from other services.
   ![img.png](src/main/resources/img/img.png)
5. Click Create Service under the summary on the right side of the console. This brings you back to the Services view. Your new service is listed with a status indicator to show that it is being created.

6. While your service is being built, you can visit the Service overview page and see the status change from REBUILDING to RUNNING.

7. After your Kafka service is up and running, you can create a kafka topic based on your own configure preference.
![img.png](src/main/resources/img/pic2.png)

## Configure Java SSL Access
Now that you have created an Aiven Kafka service and a topic, you will need to set up SSL access so that your Java code can access and produce data.

Aiven for Apache Kafka® utilises TLS (SSL) to secure the traffic between its services and client applications. This means that clients must be configured with the right tools to be able to communicate with the Aiven services.

Keystores and truststores are password-protected files accessible by the client that interacts with the service. To create these files:

- Log into the Aiven web console and select your Aiven for Apache Kafka service.

- Download the Access Key, Access Certificate and CA Certificate, as is shown on the picture. The resulting **service.key**, **service.cert** and **ca.pem** are going to be used in the following steps.


![img.png](src/main/resources/img/pic3.png)
- Use the openssl utility to create the keystore with the service.key and service.cert files downloaded previously:
```
openssl pkcs12 -export       \
-inkey service.key        \
-in service.cert           \
-out client.keystore.p12 \
-name service_key      
```
- Enter a password to protect the keystore and the key, when prompted.
- In the folder where the certificates are stored, use the keytool utility to create the truststore with the ca.pem file as input:
 ```
keytool -import  \
  -file ca.pem \
  -alias CA    \
  -keystore client.truststore.jks
```

- Enter a password to protect the truststores, when prompted. Reply to yes to confirm trusting the CA certificate, when prompted.
- The result are the keystore named client.keystore.p12 and truststore named client.truststore.jks that can be used for client applications configuration. 
- Make sure **kafka_authentication_methods.certificate** is enabled on the bottom of the overview page of your Kafka service.
![img.png](src/main/resources/img/pic4.png)

## Java Springboot Integration 

The code repo is based on Springboot framework, provides API service for batch data ingestion. It contains mainly 4 packages, including controller, producer, service, and conf. Application.java is the entry of the service.

![img.png](src/main/resources/img/pic5.png)

The API for batch data ingestion is  */avian/kafka/produce/batch*, 
you can access the api through url like : *http://localhost:8082/avian/kafka/produce/batch*

The producer package further encapsulated classes for producing data:
```
ProducerExecutor producerExecutor = new ProducerExecutor();
producerExecutor.produce(new KFKRecord(topic,message));
```
Aiven Kafka connection related configuration can be updated by changing 
the *IKafkaConstants.java* in the conf package:
```
    String BOOTSTRAP_SERVERS = "THE-URL-ON-YOUR-AIVEN-KAFKA-SERVICE.aivencloud.com:23824";
    String SSL_TRUSTSTORE_LOCATION="/YOUR-OWN-PATH-TO/client.truststore.jks";
    String SSL_TRUSTSTORE_PASSWORD="YOUR-OWN-PASSWORD";
    String SSL_KEYSTORE_TYPE= "PKCS12";
    String SSL_KEYSTORE_LOCATION="/YOUR-OWN-PATH-TO/client.keystore.p12";
    String SSL_KEYSTORE_PASSWORD="YOUR-OWN-PASSWORD";
    String SSL_KEY_PASSWORD="YOUR-OWN-PASSWORD";
```

## Local Testing
Start the service locally through IDEA or other tools by running the *Application.java*.
![img.png](src/main/resources/img/pic6.png)
The payload should be a JSONArray, with multiple JSONObject elements.
Previously, we have created a topic named *gps-topic*, so the payload looks like:
```
[
  {
    "topic":"gps_topic",
    "payload": {
      "lat": 1235,
      "log": 5679,
      "timestamp": "2021-01-01 10:10:11"
    }
  },
  {
    "topic":"gps_topic",
    "payload": {
      "lat": 1236,
      "log": 5670,
      "timestamp": "2021-01-01 10:10:12"
    }
  }
]
```
You can use postman or ARC as client to send the payload to the api. The service will produce the data to the topic specified in your payload.
After the client received 200OK, you should see the data in Aiven Kafka topics. 

- Go to Aiven Kafka service, click *topics*.
![img.png](src/main/resources/img/pic7.png)
- Go to the topic list and click the topic name that you just produced data.
![img.png](src/main/resources/img/pic8.png)

- Change the Format from binary (default) to json, then click *Fetch Messages*. You should see the data you just produced. 
![img.png](src/main/resources/img/pic9.png)

- Note that for easier debugging, you can also specify the offset for pulling the data.







